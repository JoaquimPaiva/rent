<!DOCTYPE html>
<html lang="pt-PT">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OptCar - Gerir Danos</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Gest√£o de danos por ve√≠culo" />
    <meta name="theme-color" content="#ffffff" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="OptCar" />
    <meta name="msapplication-TileColor" content="#ffffff" />

    <!-- PWA Icons -->
    <link rel="icon" href="img/favicon.ico" type="image/x-icon" />
    <link rel="icon" type="image/png" sizes="32x32" href="img/Icon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="img/Icon-16x16.png" />
    <link rel="apple-touch-icon" href="img/Icon-180x180.png" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json" />

    <link rel="stylesheet" href="css/styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <style>
      /* Estilos base */
      label {
        margin: 0;
        padding: 0;
        
        text-align: start;
      }

      /* Melhorias para a lista de danos */
      .list {
        margin-top: 16px;
        border-top: 1px solid var(--border-color);
      }

      .list-item {
        padding: 12px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .list-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
      }

      .list-item-title {
        font-weight: bold;
        color: var(--text-primary);
      }

      .list-item-meta {
        display: flex;
        gap: 12px;
        font-size: 0.9em;
        color: var(--muted);
      }

      .list-item-details {
        margin-top: 8px;
        font-size: 0.95em;
      }

      .list-item-actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }

      .damage-severity {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: bold;
      }

      .severity-low {
        background-color: #e6f7e6;
        color: #2e7d32;
      }

      .severity-medium {
        background-color: #fff8e1;
        color: #ff8f00;
      }

      .severity-high {
        background-color: #ffebee;
        color: #c62828;
      }

      /* Spinner de carregamento */
      .loading-spinner {
        display: none;
        margin: 20px auto;
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top: 4px solid #3498db;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Melhorias para acessibilidade */
      .search-container {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 8px;
      }

      /* Estilos do Modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        padding: 16px;
        box-sizing: border-box;
      }

      .modal-content {
        border-radius: 8px;
        width: 100%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .modal-header {
        padding: 16px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--muted);
      }

      .modal-body {
        padding: 16px;
      }

      /* Estilos do formul√°rio */
      .form-group {
        margin-bottom: 16px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
      }

      .form-group select,
      .form-group input[type="text"],
      .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        box-sizing: border-box;
      }

      .form-group textarea {
        min-height: 100px;
        resize: vertical;
      }

      .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 24px;
      }

      .form-message {
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 16px;
        text-align: center;
      }

      /* Estilos para fotos */
      .danoFoto {
        margin-bottom: 8px;
      }
    </style>
  </head>
  <body>
    <header class="app-header">
      <div class="header-top">
        <a href="index.html"
          ><img
            style="max-width: 150px"
            src="./img/Group 1.png"
            alt="Logo OptCar"
        /></a>
        <div class="online" aria-hidden="true"></div>
        <button
          id="theme-toggle"
          class="btn theme-btn"
          aria-label="Alternar tema claro/escuro"
          title="Alternar tema"
        >
          <span class="theme-icon">üåô</span>
        </button>
      </div>
      <nav class="nav" aria-label="Navega√ß√£o principal">
        <a href="dashboard.html" class="btn">Dashboard</a>
        <a href="criar-orcamento.html" class="btn">Novo Or√ßamento</a>
        <a href="novo-aluguer.html" class="btn">Novo Aluguer</a>
        <a href="veiculos.html" class="btn">Ve√≠culos</a>
        <a href="historico.html" class="btn">Em Vigor</a>
        <a href="terminados.html" class="btn">Terminados</a>
        <a href="logout.html" class="btn danger">Logout</a>
      </nav>
    </header>

    <main class="container">
      <section class="card" aria-labelledby="pageTitle">
        <div
          style="
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
          "
        >
          <h1 id="pageTitle">Gerir Danos do Ve√≠culo</h1>
          <div class="muted" id="veicInfo"></div>
        </div>

        <div class="search-container">
          <input
            id="search"
            type="text"
            class="search"
            placeholder="Pesquisar por contrato, tipo, localiza√ß√£o..."
            aria-label="Pesquisar danos"
          />
          <button id="btnVoltarVeiculo" class="btn">
            ‚Üê Voltar aos Ve√≠culos
          </button>
          <button id="btnNovoDano" class="btn primary">+ Novo Dano</button>
        </div>

        <div id="loading-spinner" class="loading-spinner"></div>

        <div id="listaDanos" class="list" aria-live="polite">
          <!-- Lista de danos ser√° preenchida dinamicamente -->
        </div>
      </section>
      <div class="ar"></div>
    </main>

    <!-- Modal de Novo Dano -->
    <div id="danoModal" class="modal" aria-hidden="true" role="dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="danoModalTitle">Registrar Novo Dano</h2>
          <button id="danoModalClose" class="modal-close" aria-label="Fechar">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <form id="danoForm">
            <div class="form-group">
              <label for="dTipo">Tipo de Dano*</label>
              <select id="dTipo" required>
                <option value="">Selecione...</option>
                <option value="risco">Risco</option>
                <option value="amassado">Amassado</option>
                <option value="quebra">Quebra</option>
                <option value="arranhao">Arranh√£o</option>
                <option value="furo">Furo</option>
                <option value="outro">Outro</option>
              </select>
            </div>

            <div class="form-group">
              <label for="dLocalizacao">Localiza√ß√£o*</label>
              <select id="dLocalizacao" required>
                <option value="">Selecione...</option>
                <option value="porta-dianteira-esquerda">
                  Porta Dianteira Esquerda
                </option>
                <option value="porta-dianteira-direita">
                  Porta Dianteira Direita
                </option>
                <option value="porta-traseira-esquerda">
                  Porta Traseira Esquerda
                </option>
                <option value="porta-traseira-direita">
                  Porta Traseira Direita
                </option>
                <option value="capo">Cap√¥</option>
                <option value="teto">Teto</option>
                <option value="para-choques-dianteiro">
                  Para-choques Dianteiro
                </option>
                <option value="para-choques-traseiro">
                  Para-choques Traseiro
                </option>
                <option value="farol-dianteiro">Farol Dianteiro</option>
                <option value="lanterna-traseira">Lanterna Traseira</option>
                <option value="vidro-dianteiro">Vidro Dianteiro</option>
                <option value="vidro-traseiro">Vidro Traseiro</option>
                <option value="outro">Outro</option>
              </select>
            </div>

            <div class="form-group">
              <label for="dSeveridade">Severidade*</label>
              <select id="dSeveridade" required>
                <option value="">Selecione...</option>
                <option value="baixa">Baixa</option>
                <option value="media">M√©dia</option>
                <option value="alta">Alta</option>
              </select>
            </div>

            <div class="form-group">
              <label for="dDescricao">Descri√ß√£o*</label>
              <textarea
                id="dDescricao"
                rows="3"
                required
                placeholder="Descreva o dano em detalhes..."
              ></textarea>
            </div>

            <div class="form-group">
              <label for="dContrato">Contrato Associado (opcional)</label>
              <input
                type="text"
                id="dContrato"
                placeholder="ID do contrato, se aplic√°vel"
              />
            </div>

            <div class="form-group">
              <label>Fotografias (m√°x. 3)</label>
              <div id="fotosDanoWrap" style="margin-top: 8px">
                <input
                  type="file"
                  class="danoFoto"
                  accept="image/*"
                  capture="environment"
                />
              </div>
              <button
                type="button"
                id="btnAddFotoDano"
                class="btn small"
                style="margin-top: 8px"
              >
                + Adicionar Foto
              </button>
            </div>

            <div class="form-group">
              <label for="dReparado">Status</label>
              <select id="dReparado">
                <option value="false">N√£o reparado</option>
                <option value="true">Reparado</option>
              </select>
            </div>

            <div id="danoFormMsg" class="form-message" hidden></div>

            <div class="form-actions">
              <button type="button" id="btnCancelarDano" class="btn">
                Cancelar
              </button>
              <button type="submit" id="btnGuardarDano" class="btn primary">
                Guardar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <nav class="mobile-nav" aria-label="Navega√ß√£o m√≥vel">
      <a href="dashboard.html" class="mobile-nav-item">
        <div class="mobile-nav-icon">
          <img src="./img/icons/dashboard-1-filled.svg" alt="Dashboard" />
        </div>
        <div class="mobile-nav-label">Dashboard</div>
      </a>
      <a href="criar-orcamento.html" class="mobile-nav-item">
        <div class="mobile-nav-icon">
          <img src="./img/icons/writing.png" alt="Novo Or√ßamento" />
        </div>
        <div class="mobile-nav-label">Novo</div>
      </a>
      <a href="novo-aluguer.html" class="mobile-nav-item">
        <div class="mobile-nav-icon">
          <img src="./img/icons/add-ring-fill.svg" alt="Novo Aluguer" />
        </div>
        <div class="mobile-nav-label">Novo</div>
      </a>
      <a href="veiculos.html" class="mobile-nav-item active">
        <div class="mobile-nav-icon">
          <img src="./img/icons/car.svg" alt="Ve√≠culos" />
        </div>
        <div class="mobile-nav-label">Ve√≠culos</div>
      </a>
      <a href="historico.html" class="mobile-nav-item">
        <div class="mobile-nav-icon">
          <img src="./img/icons/loading-three(1).svg" alt="Em Vigor" />
        </div>
        <div class="mobile-nav-label">Em Vigor</div>
      </a>
      <a href="terminados.html" class="mobile-nav-item">
        <div class="mobile-nav-icon">
          <img src="./img/icons/done2-filled.svg" alt="Terminados" />
        </div>
        <div class="mobile-nav-label">Terminados</div>
      </a>
    </nav>

    <!-- Firebase SDKs (compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <!-- jsPDF CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Scripts locais -->
    <script src="js/firebase.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/gerirDanos.js"></script>
    <script src="js/loading.js"></script>
    <script src="js/theme.js"></script>
    <script src="js/pwa.js"></script>
    <script src="js/criarOrcamento.js"></script>

    <script>
      window.addEventListener("DOMContentLoaded", () => {
        protectPage();

        // Mostrar spinner durante o carregamento
        const spinner = document.getElementById("loading-spinner");
        spinner.style.display = "block";

        // Loading control: espera por auth + primeira leitura dos danos
        const p = new Promise((resolve) => {
          auth.onAuthStateChanged((user) => {
            if (!user) return resolve();
            db.ref("danos").once("value").finally(resolve);
          });
        });

        window.loading?.when([p]).then(() => {
          window.dispatchEvent(new Event("page-ready"));
          spinner.style.display = "none";
          // Initialize criarOrcamento.js after jsPDF is loaded
          // if (typeof window.initCriarOrcamento === 'function') {
          //   window.initCriarOrcamento();
          // }
        });

        // Event listeners para bot√µes
        document
          .getElementById("btnVoltarVeiculo")
          ?.addEventListener("click", () => {
            window.location.href = "veiculos.html";
          });

        document
          .getElementById("btnNovoDano")
          ?.addEventListener("click", () => {
            // Implementar abertura do formul√°rio de novo dano
            // console.log("Abrir formul√°rio para novo dano");
          });
      });
    </script>

    <script>
      document.getElementById("btnNovoDano")?.addEventListener("click", () => {
        abrirModalDano();
      });

      // Fun√ß√µes para controlar o modal
      async function abrirModalDano(danoId) {
        const modal = document.getElementById("danoModal");
        if (!modal) return;

        modal.style.display = "flex";
        modal.setAttribute("aria-hidden", "false");
        document.getElementById("danoModalTitle").textContent =
          "Registrar Novo Dano";
        document.getElementById("danoForm").reset();
        document.getElementById("danoForm").removeAttribute("data-id"); // Remove data-id ao abrir
        document.getElementById("fotosDanoWrap").innerHTML =
          '<input type="file" class="danoFoto" accept="image/*" capture="environment" />';
        document.getElementById("danoFormMsg").hidden = true;

        // Se estiver em modo de edi√ß√£o, carregar dados do dano
        if (danoId) {
          document.getElementById("danoModalTitle").textContent = "Editar Dano";
          const dano = await db.ref(`danos/${danoId}`).once("value").then(snap => snap.val());
          if (dano) {
            document.getElementById("dTipo").value = dano.tipo;
            document.getElementById("dLocalizacao").value = dano.localizacao;
            document.getElementById("dSeveridade").value = dano.severidade;
            document.getElementById("dDescricao").value = dano.descricao;
            document.getElementById("dContrato").value = dano.contrato || '';
            document.getElementById("dReparado").value = String(dano.reparado);

            const fotosWrap = document.getElementById("fotosDanoWrap");
            fotosWrap.innerHTML = ''; // Limpar inputs existentes
            dano.fotos?.forEach(fotoUrl => {
              const img = document.createElement("img");
              img.src = fotoUrl;
              img.style.maxWidth = "100px";
              img.style.maxHeight = "100px";
              img.style.marginRight = "8px";
              img.style.borderRadius = "4px";
              fotosWrap.appendChild(img);
            });
            // Adicionar input para novas fotos, se houver menos de 3
            if (dano.fotos?.length < 3 || !dano.fotos) {
                const input = document.createElement("input");
                input.type = "file";
                input.className = "danoFoto";
                input.accept = "image/*";
                input.capture = "environment";
                fotosWrap.appendChild(input);
            }
          }
        }
      }

      function fecharModalDano() {
        const modal = document.getElementById("danoModal");
        if (!modal) return;

        modal.style.display = "none";
        modal.setAttribute("aria-hidden", "true");
        // Resetar o formul√°rio e remover data-id ao fechar
        document.getElementById("danoForm").reset();
        document.getElementById("danoForm").removeAttribute("data-id");
        document.getElementById("danoModalTitle").textContent = "Registrar Novo Dano";
      }

      // Event listeners para o modal
      document
        .getElementById("danoModalClose")
        ?.addEventListener("click", fecharModalDano);
      document
        .getElementById("btnCancelarDano")
        ?.addEventListener("click", fecharModalDano);
      document.getElementById("danoModal")?.addEventListener("click", (e) => {
        if (e.target === document.getElementById("danoModal")) {
          fecharModalDano();
        }
      });

      // Adicionar mais fotos
      document
        .getElementById("btnAddFotoDano")
        ?.addEventListener("click", () => {
          const fotosWrap = document.getElementById("fotosDanoWrap");
          if (!fotosWrap) return;

          const inputs = fotosWrap.querySelectorAll(".danoFoto");
          if (inputs.length >= 3) {
            alert("M√°ximo de 3 fotografias atingido");
            return;
          }

          const input = document.createElement("input");
          input.type = "file";
          input.className = "danoFoto";
          input.accept = "image/*";
          input.capture = "environment";
          fotosWrap.appendChild(input);
        });

      // Envio do formul√°rio
      document
        .getElementById("danoForm")
        ?.addEventListener("submit", async (e) => {
          e.preventDefault();
          const btnGuardar = document.getElementById("btnGuardarDano");
          const msg = document.getElementById("danoFormMsg");

          try {
            if (btnGuardar) btnGuardar.disabled = true;
            if (msg) msg.hidden = true;

            // Validar campos obrigat√≥rios
            const tipo = document.getElementById("dTipo").value;
            const localizacao = document.getElementById("dLocalizacao").value;
            const severidade = document.getElementById("dSeveridade").value;
            const descricao = document.getElementById("dDescricao").value;

            if (!tipo || !localizacao || !severidade || !descricao) {
              throw new Error("Preencha todos os campos obrigat√≥rios");
            }

            // Obter dados do ve√≠culo da URL
            const urlParams = new URLSearchParams(window.location.search);
            const veiculoId = urlParams.get("veiculoId");
            if (!veiculoId) {
              throw new Error("Ve√≠culo n√£o especificado");
            }

            // Processar fotos
            const fileInputs = Array.from(
              document.querySelectorAll("#fotosDanoWrap .danoFoto")
            );
            const fotos = [];

            // Manter fotos existentes ao editar
            const existingPhotos = [];
            const danoId = document.getElementById("danoForm").getAttribute("data-id");
            if (danoId) {
                const currentDano = await db.ref(`danos/${danoId}`).once("value").then(snap => snap.val());
                if (currentDano && currentDano.fotos) {
                    existingPhotos.push(...currentDano.fotos);
                }
            }

            for (const input of fileInputs) {
              const file = input.files?.[0];
              if (!file) continue;

              const storageRef = storage.ref(
                `veiculos/${veiculoId}/danos/${new Date().getTime()}_${file.name}`
              );
              const snapshot = await storageRef.put(file);
              const downloadURL = await snapshot.ref.getDownloadURL();
              fotos.push(downloadURL);
            }

            // Combinar fotos existentes com as novas
            const allFotos = [...existingPhotos, ...fotos];

            // Criar/Atualizar objeto do dano
            const user = auth?.currentUser || null;
            const danoData = {
              tipo,
              localizacao,
              severidade,
              descricao,
              contrato: document.getElementById("dContrato").value || null,
              fotos: allFotos.length ? allFotos : null,
              reparado: document.getElementById("dReparado").value === "true",
              veiculoId,
              criadoPor: {
                uid: user?.uid,
                email: user?.email,
                nome: user?.displayName || user?.email || "An√¥nimo",
              },
              atualizadoEm: new Date().toISOString(),
            };

            if (!danoId) {
              // Novo dano
              danoData.criadoEm = new Date().toISOString();
              await db.ref("danos").push(danoData);
              if (msg) {
                msg.textContent = "Dano registrado com sucesso!";
                msg.style.color = "green";
                msg.hidden = false;
              }
            } else {
              // Editar dano existente
              await db.ref(`danos/${danoId}`).update(danoData);
              if (msg) {
                msg.textContent = "Dano atualizado com sucesso!";
                msg.style.color = "green";
                msg.hidden = false;
              }
            }

            setTimeout(() => {
              fecharModalDano();
              carregarDanos(veiculoId);
            }, 1500);
          } catch (err) {
            if (msg) {
              msg.textContent = err.message;
              msg.style.color = "red";
              msg.hidden = false;
            }
            console.error("Erro ao registrar dano:", err);
          } finally {
            if (btnGuardar) btnGuardar.disabled = false;
          }
        });

      // Fun√ß√£o para carregar informa√ß√µes do ve√≠culo
      function carregarInfoVeiculo(veiculoId) {
        if (!veiculoId) return;

        db.ref(`veiculos/${veiculoId}`)
          .once("value")
          .then((snap) => {
            const veiculo = snap.val();
            if (!veiculo) return;

            const veicInfo = document.getElementById("veicInfo");
            if (veicInfo) {
              veicInfo.textContent = `${veiculo.marca} ${veiculo.modelo} (${veiculo.matricula})`;
            }
          });
      }

      // Fun√ß√£o para carregar e exibir os danos
      async function carregarDanos(veiculoId) {
        const listaDanosDiv = document.getElementById("listaDanos");
        const spinner = document.getElementById("loading-spinner");
        if (!listaDanosDiv || !spinner) return;

        listaDanosDiv.innerHTML = ""; // Limpar lista atual
        spinner.style.display = "block"; // Mostrar spinner

        try {
          const snapshot = await db.ref(`danos`).orderByChild('veiculoId').equalTo(veiculoId).once("value");
          let danos = snapshot.val();
          const searchTerm = document.getElementById("search").value.toLowerCase();

          if (!danos) {
            listaDanosDiv.innerHTML = '<p class="muted" style="text-align: center;">Nenhum dano registrado para este ve√≠culo.</p>';
            return;
          }

          // Converter objeto para array e ordenar por data de cria√ß√£o (mais recente primeiro)
          let danosArray = Object.keys(danos).map(key => ({ id: key, ...danos[key] }));

          // Filtrar danos se houver termo de pesquisa
          if (searchTerm) {
            danosArray = danosArray.filter(dano => {
              return (
                (dano.tipo && dano.tipo.toLowerCase().includes(searchTerm)) ||
                (dano.localizacao && dano.localizacao.toLowerCase().includes(searchTerm)) ||
                (dano.descricao && dano.descricao.toLowerCase().includes(searchTerm)) ||
                (dano.contrato && dano.contrato.toLowerCase().includes(searchTerm))
              );
            });
          }

          danosArray.sort((a, b) => new Date(b.criadoEm).getTime() - new Date(a.criadoEm).getTime());

          if (danosArray.length === 0) {
            listaDanosDiv.innerHTML = '<p class="muted" style="text-align: center;">Nenhum dano encontrado com os crit√©rios de pesquisa.</p>';
            return;
          }

          danosArray.forEach((dano) => {
            const danoElement = document.createElement("div");
            danoElement.className = "list-item";
            danoElement.innerHTML = `
              <div class="list-item-header">
                <div class="list-item-title">${dano.tipo} - ${dano.localizacao}</div>
                <span class="damage-severity severity-${dano.severidade}">${dano.severidade}</span>
              </div>
              <div class="list-item-meta">
                <span>Contrato: ${dano.contrato || 'N/A'}</span>
                <span>Criado por: ${dano.criadoPor.nome}</span>
                <span>Em: ${new Date(dano.criadoEm).toLocaleDateString()}</span>
              </div>
              <div class="list-item-details">
                ${dano.descricao}
              </div>
              ${dano.fotos ? `<div class="list-item-photos">${dano.fotos.map(foto => `<img src="${foto}" alt="Foto do dano" style="max-width: 100px; max-height: 100px; margin-right: 8px; border-radius: 4px;">`).join('')}</div>` : ''}
              <div class="list-item-actions">
                <button class="btn small" data-id="${dano.id}" onclick="editarDano('${dano.id}')">Editar</button>
                <button class="btn danger small" data-id="${dano.id}" onclick="excluirDano('${dano.id}', '${dano.veiculoId}')">Excluir</button>
              </div>
            `;
            listaDanosDiv.appendChild(danoElement);
          });
        } catch (error) {
          console.error("Erro ao carregar danos:", error);
          listaDanosDiv.innerHTML = '<p class="error" style="text-align: center;">Erro ao carregar danos.</p>';
        } finally {
          spinner.style.display = "none"; // Esconder spinner
        }
      }

      // Fun√ß√£o para abrir o modal de edi√ß√£o
      async function editarDano(danoId) {
        document.getElementById("danoForm").setAttribute("data-id", danoId);
        abrirModalDano(danoId);
      }

      // Fun√ß√£o para excluir um dano
      async function excluirDano(danoId, veiculoId) {
        if (!confirm("Tem certeza que deseja excluir este dano?")) {
          return;
        }

        try {
          await db.ref(`danos/${danoId}`).remove();
          alert("Dano exclu√≠do com sucesso!");
          carregarDanos(veiculoId); // Recarregar a lista ap√≥s a exclus√£o
        } catch (error) {
          console.error("Erro ao excluir dano:", error);
          alert("Erro ao excluir dano: " + error.message);
        }
      }

      // Carregar info do ve√≠culo e danos quando a p√°gina estiver pronta
      window.addEventListener("page-ready", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const veiculoId = urlParams.get("veiculoId");
        carregarInfoVeiculo(veiculoId);
        carregarDanos(veiculoId); // Chamar a fun√ß√£o para carregar danos
      });

      window.onload = function() {
        if (typeof window.initCriarOrcamento === 'function') {
          window.initCriarOrcamento();
        }
      };

    </script>
  </body>
</html>
