<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OptCar - Novo Aluguer</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="Sistema de gest√£o de aluguer de ve√≠culos" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="OptCar" />
  <meta name="msapplication-TileColor" content="#ffffff" />
  
  <!-- PWA Icons -->
  <link rel="icon" href="img/favicon.ico" type="image/x-icon" />
  <link rel="icon" type="image/png" sizes="32x32" href="img/Icon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="img/Icon-16x16.png" />
  <link rel="apple-touch-icon" href="img/Icon-180x180.png" />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />
  
  <link rel="stylesheet" href="css/styles.css" />

  <style>
    label {
      margin: 0;
      padding: 0;
    }
    .input-group {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="header-top">
      <a href="index.html">
        <img 
          style="max-width: 150px;" 
          src="./img/Group 1.png" 
          alt="OptCar - Gest√£o de Aluguer de Ve√≠culos"
        />
      </a>

      <div class="online" aria-hidden="true"></div>
      <button
        id="theme-toggle"
        class="btn theme-btn"
        aria-label="Alternar tema"
      >
        <span class="theme-icon">üåô</span>
      </button>
    </div>
    <nav class="nav" aria-label="Navega√ß√£o principal">
      <a href="dashboard.html" class="btn">Dashboard</a>
      <a href="criar-orcamento.html" class="btn">Novo Or√ßamento</a>
      <a href="novo-aluguer.html" class="btn">Novo Aluguer</a>
      <a href="veiculos.html" class="btn">Ve√≠culos</a>
      <a href="historico.html" class="btn">Em Vigor</a>
      <a href="terminados.html" class="btn">Terminados</a>
      <a href="logout.html" class="btn danger">Logout</a>
    </nav>
  </header>

  <main class="container">
    <form
      id="aluguerForm"
      class="card form-grid"
      autocomplete="off"
      novalidate
      aria-label="Formul√°rio de novo aluguer"
    >
      <!-- Indicador de progresso do wizard -->
      <div class="wizard-progress" aria-label="Progresso do formul√°rio">
        <div class="wizard-step-indicator active" data-step="1" aria-current="step">
          <div class="wizard-step-circle">1</div>
          <div class="wizard-step-label">Cliente</div>
        </div>
        <div class="wizard-step-indicator" data-step="2">
          <div class="wizard-step-circle">2</div>
          <div class="wizard-step-label">Ve√≠culo</div>
        </div>
        <div class="wizard-step-indicator" data-step="3">
          <div class="wizard-step-circle">3</div>
          <div class="wizard-step-label">Aluguer</div>
        </div>
        <div class="wizard-step-indicator" data-step="4">
          <div class="wizard-step-circle">4</div>
          <div class="wizard-step-label">Resumo</div>
        </div>
        <div class="wizard-step-indicator" data-step="5">
          <div class="wizard-step-circle">5</div>
          <div class="wizard-step-label">Assinatura</div>
        </div>
      </div>

      <!-- Passo 1 - Cliente -->
      <div class="wizard-step" data-step="1" aria-labelledby="clienteStepTitle">
        <h2 id="clienteStepTitle">Sec√ß√£o Cliente</h2>
        <p class="quote">
          <strong>Nota: todos os campos s√£o de preenchimento obrigat√≥rio.</strong>
        </p>
        
        <div class="input-group">
          <label for="clienteNome"><span>Nome completo</span></label>
          <input 
            type="text" 
            id="clienteNome" 
            required 
            style="text-transform: capitalize;"
            aria-required="true"
          />
        </div>
        
        <div class="grid-2">
          <div class="input-group">
            <label for="clienteDocTipo"><span>Tipo de documento</span></label>
            <select id="clienteDocTipo" aria-describedby="docTipoHelp">
              <option value="CC">CC</option>
              <option value="Passaporte">Passaporte</option>
            </select>
            <div id="docTipoHelp" class="muted" hidden>Selecione o tipo de documento</div>
          </div>
          <div class="input-group">
            <label for="clienteDocNumero"><span>N√∫mero do documento</span></label>
            <input 
              type="text" 
              id="clienteDocNumero" 
              required
              aria-required="true"
            />
          </div>
        </div>
        
        <div class="grid-3">
          <div class="input-group">
            <label for="clienteNif"><span>NIF</span></label>
            <input 
              type="text" 
              id="clienteNif" 
              required
              aria-required="true"
            />
          </div>
          <div class="input-group">
            <label for="clienteDataNasc"><span>Data de nascimento</span></label>
            <input 
              type="date" 
              id="clienteDataNasc" 
              required
              aria-required="true"
            />
          </div>
          <div class="input-group">
            <label for="clienteContacto"><span>Contacto</span></label>
            <input 
              type="tel" 
              id="clienteContacto" 
              required
              aria-required="true"
            />
          </div>
        </div>
        
        <div class="grid-2">
          <div class="input-group">
            <label for="clienteEmail"><span>Email</span></label>
            <input 
              type="email" 
              id="clienteEmail" 
              required
              aria-required="true"
            />
          </div>
          <div class="input-group full">
            <label for="clienteMorada"><span>Morada</span></label>
            <textarea 
              id="clienteMorada" 
              rows="2" 
              required 
              style="text-transform: capitalize;"
              aria-required="true"
            ></textarea>
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn primary btn-next" aria-label="Pr√≥ximo passo: Ve√≠culo">
            Seguinte
          </button>
        </div>
      </div>

      <!-- Passo 2 - Ve√≠culo -->
      <div class="wizard-step" data-step="2" style="display:none" aria-labelledby="veiculoStepTitle">
        <h2 id="veiculoStepTitle">Sec√ß√£o Ve√≠culo</h2>
        <div class="grid-2">
          <div class="input-group full">
            <label for="selVeiculo"><span>Ve√≠culo (stock)</span></label>
            <select id="selVeiculo" aria-required="true" required>
              <option value="">Seleciona um ve√≠culo do stock‚Ä¶</option>
            </select>
          </div>
          <div class="form-actions" style="align-self: end; margin: 0">
            <a href="veiculos.html" class="btn">Gerir ve√≠culos</a>
          </div>
        </div>
        
        <div
          id="veiculoDetalhes"
          class="card"
          style="padding: 12px; margin: 8px 0; display: none"
          aria-live="polite"
        >
          <strong id="vdTitulo"></strong>
          <div id="vdLinha1" class="muted" style="margin-top: 4px"></div>
          <div id="vdLinha2" class="muted" style="margin-top: 2px"></div>
        </div>
        
        <div class="input-group full">
          <label for="veicFotos"><span>Fotografias adicionais (opcional)</span></label>
          <div
            id="veicFotosWrap"
            class="foto-list"
            style="display: flex; flex-direction: row; gap: 8px;flex-wrap: wrap;"
          >
            <input
              type="file"
              id="veicFotos"
              class="veicFoto"
              accept="image/*"
              capture="environment"
            />
          </div>
          <div class="form-actions" style="margin-top: 8px">
            <button type="button" id="addFoto" class="btn">
              Adicionar fotografia
            </button>
          </div>
        </div>
        
        <div class="form-actions" style="margin-top: 8px">
          <button type="button" class="btn btn-prev" aria-label="Voltar para Cliente">
            Voltar
          </button>
          <button type="button" class="btn primary btn-next" aria-label="Pr√≥ximo passo: Aluguer">
            Seguinte
          </button>
        </div>
      </div>

      <!-- Passo 3 - Aluguer -->
      <div class="wizard-step" data-step="3" style="display:none" aria-labelledby="aluguerStepTitle">
        <h2 id="aluguerStepTitle">Sec√ß√£o Aluguer</h2>
        <div class="grid-3">
          <div class="input-group">
            <label for="algInicio"><span>In√≠cio</span></label>
            <input 
              type="datetime-local" 
              id="algInicio" 
              required
              aria-required="true"
            />
          </div>
          <div class="input-group">
            <label for="algFim"><span>Fim</span></label>
            <input 
              type="datetime-local" 
              id="algFim" 
              required
              aria-required="true"
            />
          </div>
          <div class="input-group">
            <label for="algPreco"><span>Pre√ßo total (‚Ç¨)</span></label>
            <input 
              type="number" 
              id="algPreco" 
              min="0" 
              step="0.01" 
              required
              aria-required="true"
            />
          </div>
        </div>
        
        <div class="grid-3">
          <div class="input-group">
            <label for="algPrecoDiario"><span>Pre√ßo di√°rio (‚Ç¨)</span></label>
            <input 
              type="number" 
              id="algPrecoDiario" 
              min="0" 
              step="0.01"
            />
          </div>
          <div class="input-group">
            <label for="algCaucao"><span>Cau√ß√£o (‚Ç¨)</span></label>
            <input 
              type="number" 
              id="algCaucao" 
              min="0" 
              step="0.01"
            />
          </div>
          <div class="input-group">
            <label for="algFormaPagamento"><span>Forma de pagamento</span></label>
            <select id="algFormaPagamento">
              <option value="">‚Äî</option>
              <option value="Dinheiro">Dinheiro</option>
              <option value="MBWay">MBWay</option>
              <option value="Cart√£o">Cart√£o</option>
              <option value="Transfer√™ncia">Transfer√™ncia</option>
            </select>
          </div>
        </div>
        
        <div class="input-group full">
          <label for="algLocalDevolucao"><span>Local de devolu√ß√£o</span></label>
          <input type="text" id="algLocalDevolucao" />
        </div>
        
        <div class="input-group full">
          <label for="algObs"><span>Observa√ß√µes</span></label>
          <textarea id="algObs" rows="2"></textarea>
        </div>
        
        <div class="form-actions" style="margin-top: 8px">
          <button type="button" class="btn btn-prev" aria-label="Voltar para Ve√≠culo">
            Voltar
          </button>
          <button type="button" class="btn primary btn-next" aria-label="Pr√≥ximo passo: Resumo">
            Seguinte
          </button>
        </div>
      </div>

      <!-- Passo 4 - Resumo -->
      <div class="wizard-step" data-step="4" style="display:none" aria-labelledby="resumoStepTitle">
        <h2 id="resumoStepTitle">Resumo</h2>
        <div id="resumoConteudo" class="card" style="padding:12px" aria-live="polite"></div>
        <div class="form-actions" style="margin-top: 8px">
          <button type="button" class="btn btn-prev" aria-label="Voltar para Aluguer">
            Voltar
          </button>
          <button type="button" class="btn primary btn-next" aria-label="Pr√≥ximo passo: Assinatura">
            Seguinte
          </button>
        </div>
      </div>

      <!-- Passo 5 - Assinatura -->
      <div class="wizard-step" data-step="5" style="display:none" aria-labelledby="assinaturaStepTitle">
        <h2 id="assinaturaStepTitle">Assinatura do Cliente (opcional)</h2>
        <div class="signature-wrap">
          <canvas 
            id="signaturePad" 
            width="299" 
            height="180"
            aria-label="√Årea para assinatura do cliente"
            role="img"
          ></canvas>
          <div class="signature-actions">
            <button type="button" id="clearSignature" class="btn">
              Limpar
            </button>
          </div>
        </div>

        <h2>Assinatura da Locadora (opcional)</h2>
        <div class="signature-wrap">
          <canvas 
            id="signaturePadLocadora" 
            width="299" 
            height="180"
            aria-label="√Årea para assinatura da locadora"
            role="img"
          ></canvas>
          <div class="signature-actions">
            <button type="button" id="clearSignatureLocadora" class="btn">
              Limpar
            </button>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-prev" aria-label="Voltar para Resumo">
            Voltar
          </button>
          <button type="submit" id="submitBtn" class="btn primary">
            Submeter
          </button>
          <p id="formMsg" class="info" hidden aria-live="polite"></p>
        </div>
      </div>
    </form>
    <div class="ar"></div>
  </main>

  <!-- Mobile Navigation -->
  <nav class="mobile-nav" aria-label="Navega√ß√£o m√≥vel">
    <a href="dashboard.html" class="mobile-nav-item">
      <div class="mobile-nav-icon">
        <img src="./img/icons/dashboard-1-filled.svg" alt="Dashboard" />
      </div>
      <div class="mobile-nav-label">Dashboard</div>
    </a>
    <a href="criar-orcamento.html" class="mobile-nav-item">
      <div class="mobile-nav-icon">
        <img src="./img/icons/writing.png" alt="Novo Or√ßamento" />
      </div>
      <div class="mobile-nav-label">Or√ß.</div>
    </a>
    <a href="novo-aluguer.html" class="mobile-nav-item active">
      <div class="mobile-nav-icon">
        <img src="./img/icons/add-ring-fill.svg" alt="Novo Aluguer" />
      </div>
      <div class="mobile-nav-label">Novo Al.</div>
    </a>
    <a href="veiculos.html" class="mobile-nav-item">
      <div class="mobile-nav-icon">
        <img src="./img/icons/car.svg" alt="Ve√≠culos" />
      </div>
      <div class="mobile-nav-label">Ve√≠culos</div>
    </a>
    <a href="historico.html" class="mobile-nav-item">
      <div class="mobile-nav-icon">
        <img src="./img/icons/loading-three(1).svg" alt="Alugueres em vigor" />
      </div>
      <div class="mobile-nav-label">Em Vigor</div>
    </a>
    <a href="terminados.html" class="mobile-nav-item">
      <div class="mobile-nav-icon">
        <img src="./img/icons/done2-filled.svg" alt="Alugueres terminados" />
      </div>
      <div class="mobile-nav-label">Terminados</div>
    </a>
  </nav>

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  
  <!-- jsPDF and Signature Pad -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>

  <!-- App Scripts -->
  <script src="js/firebase.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/contract.js"></script>
  <script src="js/forms.js"></script>
  <script src="js/novoAluguer.js"></script>
  <script src="js/inputs.js"></script>
  <script src="js/loading.js"></script>
  <script src="js/notifications.js"></script>
  <script src="js/theme.js"></script>
  <script src="js/pwa.js"></script>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      protectPage();
      // Esconder loading quando dados essenciais iniciais estiverem carregados
      const waiters = [];
      // esperar por popular seletor de ve√≠culos inicial
      try {
        const p = new Promise((resolve) => setTimeout(resolve, 600));
        waiters.push(p);
      } catch {}
      window.loading?.when(waiters).then(() => window.dispatchEvent(new Event('page-ready')));
    });
  </script>
</body>
</html>